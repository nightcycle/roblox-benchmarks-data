name: Release

on:
  push:
    branches:
      - main

jobs:
  extract_version:
    name: Extract Version from PR
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      pr_body: ${{ steps.extract_version.outputs.pr_body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to check tags

      - name: Extract version from PR title
        id: extract_version
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const prTitle = pr.title;
            const prBody = pr.body || "";
            console.log(`PR Title: ${prTitle}`);

            const semverRegex = /^v(\d+)\.(\d+)\.(\d+)(?:-([a-zA-Z0-9\-]+(?:\.[a-zA-Z0-9\-]+)*))?(?:\+([a-zA-Z0-9\-]+(?:\.[a-zA-Z0-9\-]+)*))?/;
            const match = prTitle.match(semverRegex);

            if (match) {
              const versionTag = match[0];
              console.log(`Extracted version: ${versionTag}`);
              return {
                version: versionTag,
                pr_body: Buffer.from(prBody).toString('base64') // Encode PR body as base64
              };
            } else {
              console.log(`No valid semantic version found in PR title.`);
              exit 1; // Exit with failure if no valid version is found
            }

  create_release:
    runs-on: ubuntu-latest
    needs: extract_version

    steps:
      - uses: actions/checkout@v4

      - name: Download all RBXL artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rbxl-*
          merge-multiple: true
          path: ./release-files

      - name: Create Release
        uses: actions/github-script@v7
        if: ${{ needs.extract_version.outputs.version != 'v0.0.0' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            let version = "${{ needs.extract_version.outputs.version }}";
            const releaseDir = './release-files';

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: version,
              body: "Release created from PR #${context.payload.pull_request.number}",
              draft: false,
              prerelease: false
            });

            console.log(`Created release: ${release.data.html_url}`);

            // Upload all RBXL files as release assets
            if (fs.existsSync(releaseDir)) {
              const files = fs.readdirSync(releaseDir);

              for (const file of files) {
                if (file.endsWith('.rbxl')) {
                  const filePath = path.join(releaseDir, file);
                  const fileContent = fs.readFileSync(filePath);

                  await github.rest.repos.uploadReleaseAsset({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.data.id,
                    name: file,
                    data: fileContent
                  });

                  console.log(`Uploaded ${file} to release`);
                }
              }
            }